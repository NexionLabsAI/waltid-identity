<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age Verification Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .verification-container {
            text-align: center;
            margin-top: 40px;
        }
        #qr-container {
            margin: 20px auto;
            width: 256px;
            height: 256px;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #e0f2e9;
            color: #0f5132;
        }
        .error {
            background-color: #f8d7da;
            color: #842029;
        }
        .button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #0052a3;
        }
    </style>
</head>
<body>
<div class="verification-container">
    <h1>Age Verification Demo</h1>
    <p>Click the button below to verify your age using your digital wallet</p>
    <button class="button" onclick="initiateAgeVerification()">Verify Age</button>
    <div id="qr-container"></div>
    <div id="status"></div>
</div>
<script>
    class VerificationClient {
        constructor(apiBaseUrl) {
            this.apiBaseUrl = apiBaseUrl;
        }

        async requestVerification() {
            try {
                const response = await fetch(`${this.apiBaseUrl}/openid4vc/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',

                    },
                    body: JSON.stringify({
                        "request_credentials": [
                            { "vct": "VerifiableCredentialType", "format": "vc+sd-jwt" }
                        ],
                        "policies": {
                            "age_verification": {
                                "min_age": 18
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to create verification request: ${response.statusText}`);
                }
                const verificationUrl = await response.text()
                const requestId = extractSessionId(verificationUrl);
                return { verificationUrl, requestId };
            } catch (error) {
                console.error('Request creation error:', error);
                throw error;
            }
        }

        async checkVerificationStatus(requestId) {
            try {
                const response = await fetch(`${this.apiBaseUrl}/openid4vc/session/${requestId}`);
                if (!response.ok) {
                    throw new Error(`Failed to check status: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Status check error:', error);
                throw error;
            }
        }
    }

    const client = new VerificationClient('http://localhost:7003');

    // Function to extract the session_id (state parameter) from the URL
    function extractSessionId(url) {
        try {
            // Replace the custom scheme with 'https' to create a valid URL object
            const normalizedUrl = url.replace('openid4vp://', 'https://');
            const parsedUrl = new URL(normalizedUrl);
            const params = new URLSearchParams(parsedUrl.search);
            return params.get('state');
        } catch (error) {
            console.error('Invalid URL:', error);
            return null;
        }
    }

    function updateStatus(message, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.className = `status ${isError ? 'error' : 'success'}`;
        statusDiv.textContent = message;
    }

    function generateQRCode(url) {
        const qrContainer = document.getElementById('qr-container');
        qrContainer.innerHTML = ''; // Clear previous QR code

        new QRCode(qrContainer, {
            text: url,
            width: 256,
            height: 256
        });

        // Create URL display div
        const urlDisplay = document.createElement('div');
        urlDisplay.style.marginTop = '10px';

        // Create copy button
        const copyButton = document.createElement('button');
        copyButton.textContent = 'Copy URL';
        copyButton.style.marginTop = '5px';
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(url);
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = 'Copy URL';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                copyButton.textContent = 'Copy failed';
            }
        });

        // Add elements to container
        qrContainer.appendChild(copyButton);
    }

    class WalletClient {
        constructor(apiBaseUrl) {
            this.apiBaseUrl = apiBaseUrl;
        }

        async login(username, password) {
            const response = await fetch(`${this.apiBaseUrl}/api/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                throw new Error('Login failed');
            }

            return response.json();
        }

        async getDids(token) {
            const response = await fetch(`${this.apiBaseUrl}/api/did/list`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to retrieve DIDs');
            }

            return response.json();
        }

        async presentCredential(token, presentationUrl) {
            const response = await fetch(`${this.apiBaseUrl}/api/wallet/present`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    presentationUrl: presentationUrl
                })
            });

            if (!response.ok) {
                throw new Error('Failed to present credential');
            }

            return response.json();
        }
    }

    // Usage example - add this to your existing code
    async function completeVerificationWithWallet(presentationUrl) {
        const walletClient = new WalletClient('http://localhost:7001');

        try {
            // Login to wallet
            const authResponse = await walletClient.login('your-username', 'your-password');
            const token = authResponse.token;

            // Get DIDs
            const dids = await walletClient.getDids(token);

            if (dids && dids.length > 0) {
                // Present credential using the first DID
                const presentationResponse = await walletClient.presentCredential(token, presentationUrl);
                return presentationResponse;
            } else {
                throw new Error('No DIDs found in wallet');
            }
        } catch (error) {
            console.error('Wallet verification failed:', error);
            throw error;
        }
    }

    // Modify the existing initiateAgeVerification function to include wallet integration
    async function initiateAgeVerification() {
        try {
            updateStatus('Initiating verification...');
            const { verificationUrl, requestId } = await client.requestVerification();

            // Instead of showing QR code, use wallet directly
            await completeVerificationWithWallet(verificationUrl);
            updateStatus('Verification request sent through wallet');

            // Continue with existing polling logic
            const pollInterval = setInterval(async () => {
                try {
                    const status = await client.checkVerificationStatus(requestId);
                    if (status.verificationResult === true) {
                        clearInterval(pollInterval);
                        if (status.result.isVerified) {
                            updateStatus('Age verification successful! Access granted.');
                        } else {
                            updateStatus('Age verification failed. Access denied.', true);
                        }
                    }
                } catch (error) {
                    clearInterval(pollInterval);
                    updateStatus('Error checking verification status: ' + error.message, true);
                }
            }, 2000);
        } catch (error) {
            updateStatus('Verification process failed: ' + error.message, true);
        }
    }
</script>
</script>
</body>
</html>
